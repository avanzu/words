<?php

namespace AppBundle\Repository;

use AppBundle\Entity\User;
use Components\Model\UserProfile;

/**
 * UserRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 *
 * @method User findOneBy(array $criteria, array $orderBy=null)
 */
class UserRepository extends ResourceRepository
{

    /**
     * @param $criteria
     *
     * @return User|false
     */
    public function findUserByUsernameOrEmail($criteria)
    {
        $builder = $this->createQueryBuilder('user');
        $expr    = $builder->expr();
        $orX     = $expr->orX();
        $orX->add($expr->eq('user.username', ':criteria'))
            ->add($expr->eq('user.email', ':criteria'));

        $result = $builder
            ->where($orX)
            ->setParameter('criteria', $criteria)
            ->setMaxResults(1)
            ->getQuery()
            ->getResult();

        return current($result);
    }

    /**
     * @param $model
     *
     * @return UserProfile
     */
    public function fetchUserProfile($model) {
        return current(
            $this
                ->createQueryBuilder('user')
                ->leftJoin('user.profile', 'profile')
                ->select(
                    sprintf(
                        'new %s(user.id, user.username, user.email, profile.gender, profile.firstName, profile.lastName, profile.avatar)',
                        UserProfile::class
                    )
                )
                ->where('user = :model')
                ->setParameter('model', $model)
                ->getQuery()
                ->getResult()
            );

    }
}
